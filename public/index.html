<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="protovis.js"></script>
    <script type="text/javascript" src="underscore-min.js"></script>
    <script type="text/javascript" src="d3.min.js"></script>
    <style type="text/css">
        .link { stroke: #ccc; }
        .nodetext { pointer-events: none; font: 10px sans-serif; }
        body { width:100%; height:100%; margin:none; padding:none; }
        #graph { width:700px;height:600px; border:3px solid black;border-radius:12px; float: left; margin-left: 5%; margin-top: 1%; }
        
        #controls{
            width: 25%;
            float: right;
            margin-right: 2%;
            margin-top: 1%;
        }
        
        .title {
            font-size: 60px;
            font-family: "Bebas Neue";
        }
        
        #inputcontrols {
            width: 70%;
        }
    </style>
</head>
<body>
<div id="graph"></div>


<div id="controls">
    <div id="title"><p class="title">Graph Note v1</p></div>
    
    <div id="inputcontrols">
    
        <input type="text" class="addquery" placeholder="NodeName" name="" value="" />
        <button onclick="addNde()">AddNode</button>
        
        <input type="text" class="remquery" placeholder="Node" name="" value="" />
        <button onclick="remNde()">RemoveNode</button>
        
        <!--  Links :  -->
        <input type="text" class="linkqueryfrst" placeholder="Link1" name="" value="" />
        
        <input type="text" class="linkquerysecd" placeholder="Link2" name="" value="" />
        
        <button onclick="addLnk()">AddLink</button>
        
        <!-- Mutuals -->
        <button onclick="mutuals()">Mutuals</button>
    
    </div> <!--  end inputcontrols   -->
    
    <div id="database">
<!--        <textarea id="hello">""</textarea>-->
<!--        <button id="submit">Submit</button>-->
        <button id="getres">get</button>
        <div id="example"></div>
        <div id="map"></div>
        <div id = "photos"></div>
    </div>
    
    
</div>  <!-- END CONTROLS -->

</body><script type="text/javascript">

//GRAPH SETTING 
function myGraph(el) {

    // Add and remove elements on the graph object
    this.addNode = function (id) {
        //console.log(id);
        nodes.push({"id":id});
        update();
    }

    this.removeNode = function (id) {
        var i = 0;
        var n = findNode(id);
        while (i < links.length) {
            if ((links[i]['source'] == n)||(links[i]['target'] == n)) links.splice(i,1);
            else i++;
        }
        nodes.splice(findNodeIndex(id),1);
        update();
    }

    this.addLink = function (source, target) {
        links.push({"source":findNode(source),"target":findNode(target)});
        update();
    }

    var findNode = function(id) {
        for (var i in nodes) {if (nodes[i]["id"] === id) return nodes[i]};
    }

    var findNodeIndex = function(id) {
        for (var i in nodes) {if (nodes[i]["id"] === id) return i};
    }

    // set up the D3 visualisation in the specified element
    var w = $(el).innerWidth(),
        h = $(el).innerHeight();

    var vis = this.vis = d3.select(el).append("svg:svg")
        .attr("width", w)
        .attr("height", h);

    var force = d3.layout.force()
        .gravity(.05)
        .distance(100)
        .charge(-200)
        .size([w, h]);

    
    var nodes = force.nodes(),
        links = force.links();
        
    var update = function () {

        var link = vis.selectAll("line.link")
            .data(links, function(d) { return d.source.id + "-" + d.target.id; });

        link.enter().insert("line")
            .attr("class", "link");

        link.exit().remove();
        //console.log(links);
        
        
        var node = vis.selectAll("g.node")
            .data(nodes, function(d) { return d.id;});

        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .call(force.drag);

        nodeEnter.append("image")
            .attr("class", "circle")
            .attr("xlink:href", "node.png")
            .attr("x", "-8px")
            .attr("y", "-8px")
            .attr("width", "16px")
            .attr("height", "16px");

        nodeEnter.append("text")
            .attr("class", "nodetext")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(function(d) {return d.id});

        node.exit().remove();

        force.on("tick", function() {
          link.attr("x1", function(d) { return d.source.x; })
              .attr("y1", function(d) { return d.source.y; })
              .attr("x2", function(d) { return d.target.x; })
              .attr("y2", function(d) { return d.target.y; });

          node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        });

        // Restart the force layout.
        force.start();
    }

    // Make it all go
    update();
}



//////////////// EXECT/////////////////////////////////
// You can do this from the console as much as you like...

graph = new myGraph("#graph");

//SET DATABASE ARRAy

var miserables = {
  nodes:[
//    {nodeName:"Manon"},
//    {nodeName:"Djoann"},
//    {nodeName:"Manon"},
//    {nodeName:"Veezio", group:4},
//    {nodeName:"Favourite", group:3},
//    {nodeName:"Blacheville", group:3},
//    {nodeName:"Dahlia", group:3},
//    {nodeName:"Zephine", group:3},
//    {nodeName:"Augment", group:3},
//    {nodeName:"Qunb", group:5},
//    {nodeName:"Homengo", group:4},
//    {nodeName:"Fabien", group:0},
//    {nodeName:"Mamee", group:2},
  ],
  links:[
//    {de:"Manon", vers:"Djoann"},
//    {de:"Djoann", vers:"Blacheville"},
//    {de:"Djoann", vers:"Veezio"},
//    
//    
//    
//    {de:"Blacheville", vers:"Manon"},
//    
//    {de:"Dahlia", vers:"Zephine"},
//    {de:"Augment", vers:"Zephine"},
//    {de:"Dahlia", vers:"Augment"},
//    {de:"Djoann", vers:"Favourite"}
  ]
};

//miserables DB insert graph
for (var i = 0; i < miserables.nodes.length; i++) {
	var a = miserables.nodes[i].nodeName;
	//console.log(a);
	graph.addNode(a);
}

for (var i = 0; i < miserables.links.length; i++) {
    var b = miserables.links[i].de;
    var c = miserables.links[i].vers;
    //console.log(b , "link", c);
    graph.addLink(b, c);
}

</script>

<script type="text/javascript">



//BASIC GRAPH FUNCTIONS 
/***************************************************************/
    //function controls
    function addNde() {
    var id = $(".addquery").val();
    
        if (id.length == 0) {
        console.log("vide");
        } else {
        
        saved(id);
        graph.addNode(id);
        
        //graph.addLink(id,"Djoann")  add link to the core nodeName?
        } // en if
    }; // end function
    
    function remNde() {
    var query = $(".remquery").val();
        if (query.length == 0) {
        console.log("vide");
        } else {
        graph.removeNode(query);
        } // end if
    } // end function
    

    
    
/***************************************************************/
    //mutuals function
    function mutuals(friendName) {
          //mutuals
          var friendName = "Fabien";
          //console.log(friendName);
           
          //console.log("rzfregeqhgqetbetgqetgqv");
          var response = {
          data:[
            {nodeName:"Pierre"},
            {nodeName:"Micko"},
            {nodeName:"Homengo"}
          ]};
          
          
          for (var i = 0; i < response.data.length; i++) {
          	var a = response.data[i].nodeName;
          	//console.log(a);
          	graph.addNode(a);
          	graph.addLink(a,friendName);
          	console.log( friendName , "names : ", a);          
          	
          }
          console.log(friendName, "end mutuals suceed");
    };
    
    
    
/***************************************************************/
//database functions

    
    //get database nodes and links
    $("#getres").click( function () {
        //c = resultats
        $.get("/graphdb?dirty=true", function (c) {
                console.log(c);
                addNde(c);
                function addNde(c) {
                
                //nodes add graph
                for (var i = 0; i <c.length; i++) {
                    var name = c[i].node.name;
                    graph.addNode(name);
                    console.log(name);
                }
                
                //links add graph
                for (var i = 0; i <c.length; i++) {
                    var a = c[i].node.link1;
                    var b = c[i].node.link2;
                    graph.addLink(a,b);
                    console.log(a,b);   
                }
            }; // end function          
                //$("#example").html(JSON.stringify(c));
        })
    });
    
    
    // save addNode in database
    function saved(id) {
        console.log(id);
        
        //serialiser le json
        var json = { "name" : id };
        
        //JSON.stringify(thing);
        // transformer la string en json
        //var str = JSON.stringify(json);
        //envoyer vers le server
        $.post("/graphdb", json, function (c) {
            alert("Saved" + JSON.stringify(c));
            console.log(JSON.stringify(c));
            //savegarder
        });
        
    
    }
    
    
    //ajouter des liens dans la database
    function addLnk() {
    var onequery = $(".linkqueryfrst").val();
    var secquery = $(".linkquerysecd").val();
    
        if (onequery.length == 0) {
        console.log("vide");
        } else if (secquery.length == 0) {
        console.log("vide");
        } else {
        console.log(onequery, "linked via", secquery);
        graph.addLink(onequery,secquery);
        
        var json = { "link1" : onequery, "link2" : secquery };
        $.post("/graphdb", json, function (c) {
            alert("Saved" + JSON.stringify(c));
            console.log(JSON.stringify(c));
            //savegarder
        });
        }// end if

    }
    
    
    
    
</script>

</html>